<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced DRM Video Player</title>
    <link rel="stylesheet" href="//cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.css">
    <style>
        /* General Reset and Box Model */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 50px auto;
            padding: 30px;
            background-color: #1f1f1f;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
            text-align: center;
            width: 95%;
        }

        .container h1 {
            font-size: 2.5rem;
            color: #ffffff;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .video-container {
            width: 100%;
            margin-bottom: 20px;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        #player {
            width: 100%;
            height: 600px;
            background: #000;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        .container input, .container button {
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            border-radius: 5px;
            font-size: 16px;
            border: 1px solid #555;
            box-sizing: border-box;
        }

        .container input {
            background-color: #222;
            color: #fff;
        }

        .container input::placeholder {
            color: #888;
        }

        .container button {
            background-color: #1a73e8;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .container button:hover {
            background-color: #155ab3;
        }

        .error-message {
            color: #ff4444;
            margin-top: 10px;
            font-size: 14px;
            display: none;
            padding: 10px;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 5px;
            border: 1px solid #ff4444;
        }

        .success-message {
            color: #4CAF50;
            margin-top: 10px;
            font-size: 14px;
            display: none;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
            border: 1px solid #4CAF50;
        }

        .info-text {
            margin-top: 15px;
            color: #aaa;
            font-size: 14px;
            text-align: left;
        }
        
        .info-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .info-text li {
            margin-bottom: 5px;
        }
        
        .format-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .format-tag {
            background: rgba(26, 115, 232, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            border: 1px solid #1a73e8;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                width: 100%;
                max-width: 100%;
                box-shadow: none;
            }

            #player {
                height: 250px;
            }

            .container h1 {
                font-size: 1.8rem;
            }

            .container input, .container button {
                font-size: 14px;
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .container h1 {
                font-size: 1.6rem;
            }

            #player {
                height: 200px;
            }

            .container button {
                font-size: 13px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Advanced DRM Video Player</h1>
        <div class="video-container">
            <div id="player"></div>
        </div>
        
        <!-- Status Messages -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- Input Fields for Video URL and DRM Information -->
        <form id="videoForm">
            <input type="text" id="link" placeholder="Enter MPD, M3U8, or MP4 URL" required />
            <input type="text" id="clearKeyPair" placeholder="Enter ClearKey (keyId:key) [Optional]" />
            <input type="text" id="widevineLicenseUrl" placeholder="Enter Widevine License URL [Optional]" />
            <input type="text" id="clearKeyUrl" placeholder="Enter ClearKey URL [Optional]" />
            <button type="button" id="playButton">Play Video</button>
        </form>
        
        <div class="info-text">
            <p><strong>Test URLs:</strong></p>
            <ul>
                <li>MPD: https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd</li>
                <li>HLS: https://storage.googleapis.com/shaka-demo-assets/angel-one-hls/hls.m3u8</li>
                <li>MP4: https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4</li>
            </ul>
        </div>
        
        <div class="format-tags">
            <span class="format-tag">MPD</span>
            <span class="format-tag">M3U8</span>
            <span class="format-tag">MP4</span>
            <span class="format-tag">Widevine</span>
            <span class="format-tag">Clearkey</span>
            <span class="format-tag">DRM</span>
        </div>
    </div>

    <script src="//cdn.bitmovin.com/player/web/8/bitmovinplayer.js"></script>
    <script src="//cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.js"></script>
    <script>
        // Debug function
        function showMessage(message, isError = false) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            if (isError) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            } else {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }
            
            console.log(isError ? 'ERROR: ' + message : 'SUCCESS: ' + message);
        }

        // Override licensing URLs
        function override(url) {
            if (url.indexOf("licensing.bitmovin.com/licensing") > -1)
                return "data:text/plain;base64,eyJzdGF0dXMiOiJncmFudGVkIiwibWVzc2FnZSI6IlRoZXJlIHlvdSBnby4ifQ==";
            if (url.indexOf("licensing.bitmovin.com/impression") > -1)
                return "data:text/plain;base64,eyJzdGF0dXMiOiJncmFudGVkIiwibWVzc2FnZSI6IlRoZXJlIHlvdSBnby4ifQ==";
            return url;
        }

        var opens = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function () {
            var url = override(arguments[1]);
            arguments[1] = url;
            return opens.apply(this, arguments);
        };

        // Player configuration
        const conf = {
            key: "6feaf539-dba6-4ec3-b9f3-92c0fa71dfed",
            ui: true, // Changed to true to use default UI
            playback: {
                autoplay: true,
                muted: true, // Changed to true to avoid autoplay restrictions
                autoplayEnabled: true,
                mutedAutoplayEnabled: true
            },
            logging: {
                level: 'debug' // Enable debug logging
            }
        };

        let player;

        // Initialize player when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                player = new bitmovin.player.Player(document.getElementById('player'), conf);
                showMessage('Player initialized successfully!');
                
                // Add event listeners for debugging
                player.on(bitmovin.player.PlayerEvent.Ready, function() {
                    console.log('Player is ready');
                    showMessage('Player is ready and waiting for content');
                });
                
                player.on(bitmovin.player.PlayerEvent.SourceLoaded, function() {
                    console.log('Source loaded successfully');
                    showMessage('Video source loaded successfully');
                });
                
                player.on(bitmovin.player.PlayerEvent.Error, function(data) {
                    console.error('Player error:', data);
                    showMessage('Error: ' + (data.message || 'Unknown error occurred'), true);
                });
                
                player.on(bitmovin.player.PlayerEvent.MetadataParsed, function(data) {
                    console.log('Metadata parsed:', data);
                });
                
            } catch (error) {
                console.error('Failed to initialize player:', error);
                showMessage('Failed to initialize player: ' + error.message, true);
            }
        });

        // DOM Elements
        const videoUrlInput = document.getElementById('link');
        const clearKeyPairInput = document.getElementById('clearKeyPair');
        const widevineLicenseUrlInput = document.getElementById('widevineLicenseUrl');
        const clearKeyUrlInput = document.getElementById('clearKeyUrl');
        const playButton = document.getElementById('playButton');

        // Event Listeners
        playButton.addEventListener('click', playVideo);

        // Play video function
        function playVideo() {
            const url = videoUrlInput.value.trim();
            const clearKeyPair = clearKeyPairInput.value.trim();
            const widevineLicenseUrl = widevineLicenseUrlInput.value.trim();
            const clearKeyUrl = clearKeyUrlInput.value.trim();
            
            if (!url) {
                showMessage('Please enter a video URL', true);
                return;
            }
            
            if (!player) {
                showMessage('Player not initialized. Please refresh the page.', true);
                return;
            }
            
            showMessage('Loading video...');
            
            let source = {
                title: 'Custom Video',
                poster: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4Mb0O5o5z_YNLfcbNjILSw-kRR-uIXD31L9sMFhswqnSqj3Ho3XRWWbOLLe9ROvS5JSWHM1VKymuxBo-BwbzcpTQ03SjLuP6HuwIokQrCay1aZlT6h4wu84Q2qDlPxSdUp1MFCc5wdUN358jBx5tInVtteCRWEWrkCYn8HkgJt6Kk8e8hDKXDVPenpzGi/s1600/bgtv2.jpg'
            };
            
            // Determine source type based on URL extension
            if (url.toLowerCase().endsWith('.mpd')) {
                source.dash = url;
                console.log('Detected DASH source');
            } else if (url.toLowerCase().endsWith('.m3u8')) {
                source.hls = url;
                console.log('Detected HLS source');
            } else if (url.toLowerCase().endsWith('.mp4')) {
                source.progressive = url;
                console.log('Detected MP4 source');
            } else {
                // Default to progressive for unknown formats
                source.progressive = url;
                console.log('Unknown format, defaulting to progressive');
            }
            
            // Add DRM if provided
            if (clearKeyPair) {
                try {
                    const [kid, key] = clearKeyPair.split(':');
                    if (kid && key) {
                        source.drm = {
                            clearkey: {
                                keyId: kid.trim(),
                                key: key.trim()
                            }
                        };
                        console.log('Added ClearKey DRM:', { kid: kid.trim(), key: key.trim() });
                    } else {
                        console.warn('Invalid ClearKey format. Expected format: keyId:key');
                    }
                } catch (e) {
                    console.warn('Error parsing ClearKey pair:', e);
                }
            }
            
            // Add Widevine license URL if provided
            if (widevineLicenseUrl) {
                if (!source.drm) source.drm = {};
                source.drm.widevine = {
                    LA_URL: widevineLicenseUrl
                };
                console.log('Added Widevine license URL:', widevineLicenseUrl);
            }
            
            // Add ClearKey URL if provided
            if (clearKeyUrl) {
                if (!source.drm) source.drm = {};
                source.drm.clearkey = {
                    LA_URL: clearKeyUrl
                };
                console.log('Added ClearKey URL:', clearKeyUrl);
            }
            
            console.log('Loading source:', source);
            
            // Load the source
            player.load(source).then(() => {
                console.log('Video loaded successfully');
                showMessage('Video loaded successfully!');
            }).catch(error => {
                console.error('Error loading video:', error);
                showMessage('Error loading video: ' + (error.message || 'Check console for details'), true);
            });
        }

        // Handle fullscreen changes for mobile devices
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        function handleFullscreenChange() {
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                if (isMobileDevice() && screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {});
                }
            } else {
                if (isMobileDevice() && screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    </script>
</body>
</html>
